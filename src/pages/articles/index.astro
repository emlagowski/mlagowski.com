---
import Layout from "../../components/Layout.astro";
import ArticleCard from "../../components/ArticleCard.astro";
import { getCollection } from "astro:content";

const articles = (await getCollection("articles"))
  .filter((article) => !article.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const featuredArticles = articles.filter((a) => a.data.featured);
const otherArticles = articles.filter((a) => !a.data.featured);

// Collect all unique tags
const allTags = [...new Set(articles.flatMap((a) => a.data.tags))].sort();
---

<Layout
  title="Articles"
  description="Thoughts, tutorials, and insights on software development"
>
  <section class="articles">
    <div class="container">
      <header class="articles-header">
        <h1>Articles</h1>
        <p>Thoughts, tutorials, and insights.</p>
      </header>

      <!-- Tag Filter -->
      {
        allTags.length > 0 && (
          <div class="tag-filter" id="tag-filter">
            <button class="filter-tag active" data-tag="">
              All
            </button>
            {allTags.map((tag) => (
              <button class="filter-tag" data-tag={tag}>
                {tag}
              </button>
            ))}
          </div>
        )
      }

      {
        featuredArticles.length > 0 && (
          <section class="articles-section" data-section="featured">
            <h2>Featured</h2>
            <div class="articles-grid articles-grid-featured">
              {featuredArticles.map((article) => (
                <div
                  class="article-wrapper"
                  data-tags={article.data.tags.join(",")}
                >
                  <ArticleCard
                    title={article.data.title}
                    description={article.data.description}
                    href={`/articles/${article.slug}`}
                    date={article.data.date}
                    tags={article.data.tags}
                    coverImage={article.data.coverImage}
                    theme={article.data.coverTheme}
                  />
                </div>
              ))}
            </div>
          </section>
        )
      }

      {
        otherArticles.length > 0 && (
          <section class="articles-section" data-section="other">
            {featuredArticles.length > 0 && <h2>Other Articles</h2>}
            <div class="articles-list">
              {otherArticles.map((article) => (
                <div
                  class="article-wrapper"
                  data-tags={article.data.tags.join(",")}
                >
                  <ArticleCard
                    title={article.data.title}
                    description={article.data.description}
                    href={`/articles/${article.slug}`}
                    date={article.data.date}
                    tags={article.data.tags}
                  />
                </div>
              ))}
            </div>
          </section>
        )
      }

      {
        articles.length === 0 && (
          <p class="empty-state">No articles yet. Check back soon!</p>
        )
      }
    </div>
  </section>
</Layout>

<script>
  function initFilters() {
    const filterContainer = document.getElementById("tag-filter");
    if (!filterContainer) return;

    const filterButtons = filterContainer.querySelectorAll(".filter-tag");
    const articleWrappers = document.querySelectorAll(".article-wrapper");
    const sections = document.querySelectorAll(".articles-section");

    // Read initial filter from URL
    const urlParams = new URLSearchParams(window.location.search);
    const initialTag = urlParams.get("tag") || "";

    function setActiveFilter(tag: string) {
      // Update active button state
      filterButtons.forEach((btn) => {
        const btnTag = btn.getAttribute("data-tag") || "";
        btn.classList.toggle("active", btnTag === tag);
      });

      // Filter articles
      articleWrappers.forEach((wrapper) => {
        const tags = (wrapper.getAttribute("data-tags") || "").split(",");
        const matches = tag === "" || tags.includes(tag);
        (wrapper as HTMLElement).style.display = matches ? "" : "none";
      });

      // Hide section headers if all articles in section are hidden
      sections.forEach((section) => {
        const visibleArticles = section.querySelectorAll(
          '.article-wrapper:not([style*="display: none"])',
        );
        (section as HTMLElement).style.display =
          visibleArticles.length > 0 ? "" : "none";
      });

      // Update URL without reload
      const url = new URL(window.location.href);
      if (tag) {
        url.searchParams.set("tag", tag);
      } else {
        url.searchParams.delete("tag");
      }
      window.history.replaceState({}, "", url);
    }

    // Set initial state
    setActiveFilter(initialTag);

    // Add click handlers
    filterButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tag = btn.getAttribute("data-tag") || "";
        setActiveFilter(tag);
      });
    });
  }

  // Initialize on page load
  initFilters();

  // Re-initialize on Astro page transitions
  document.addEventListener("astro:page-load", initFilters);
</script>

<style>
  .articles {
    padding: calc(70px + var(--space-16)) 0 var(--space-16);
  }

  .articles-header {
    text-align: center;
    margin-bottom: var(--space-8);
  }

  .articles-header h1 {
    margin-bottom: var(--space-3);
  }

  .articles-header p {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
  }

  /* Tag Filter */
  .tag-filter {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    flex-wrap: wrap;
    margin-bottom: var(--space-10);
  }

  .filter-tag {
    padding: var(--space-1) var(--space-3);
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: 500;
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .filter-tag:hover {
    border-color: var(--color-text-secondary);
    color: var(--color-text-secondary);
  }

  .filter-tag.active {
    border-color: var(--color-accent);
    color: var(--color-accent);
    background-color: var(--color-accent-subtle);
  }

  .articles-section {
    margin-bottom: var(--space-12);
  }

  .articles-section h2 {
    font-size: var(--text-lg);
    color: var(--color-text-muted);
    margin-bottom: var(--space-6);
  }

  .articles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: var(--space-6);
  }

  .articles-grid-featured {
    grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
  }

  .articles-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .article-wrapper {
    display: block;
  }

  .empty-state {
    text-align: center;
    color: var(--color-text-muted);
    padding: var(--space-16) 0;
  }

  @media (max-width: 480px) {
    .articles-grid,
    .articles-grid-featured {
      grid-template-columns: 1fr;
    }
  }
</style>
