---
import Layout from "../../components/Layout.astro";
import { getCollection, type CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const articles = await getCollection("articles");
  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

type Props = { article: CollectionEntry<"articles"> };
const { article } = Astro.props;
const { Content } = await article.render();

const formattedDate = article.data.date.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

// Calculate reading time (rough estimate: 200 words per minute)
const content = article.body || "";
const wordCount = content.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);

const hasCover = !!article.data.coverImage;
const coverTheme = article.data.coverTheme || "dark";
// Ensure cover image path starts with /
const coverImagePath = article.data.coverImage?.startsWith("/")
  ? article.data.coverImage
  : `/${article.data.coverImage}`;
---

<Layout title={article.data.title} description={article.data.description}>
  <article class="article-detail">
    {
      hasCover && (
        <div class={`article-cover ${coverTheme}`}>
          <img
            src={coverImagePath}
            alt={article.data.title}
            class="cover-image"
          />
          <div class="cover-overlay" />
          <div class="cover-content container container-narrow">
            <a href="/articles" class="back-link">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                width="18"
                height="18"
              >
                <line x1="19" y1="12" x2="5" y2="12" />
                <polyline points="12 19 5 12 12 5" />
              </svg>
              Back to Articles
            </a>

            <div class="article-meta">
              <time datetime={article.data.date.toISOString()}>
                {formattedDate}
              </time>
              <span class="separator">·</span>
              <span>{readingTime} min read</span>
            </div>

            <h1>{article.data.title}</h1>

            {article.data.tags && article.data.tags.length > 0 && (
              <div class="article-tags">
                {article.data.tags.map((tag) => (
                  <a
                    href={`/articles?tag=${encodeURIComponent(tag)}`}
                    class="tag"
                  >
                    {tag}
                  </a>
                ))}
              </div>
            )}
          </div>
        </div>
      )
    }

    <div class="container container-narrow">
      {
        !hasCover && (
          <header class="article-header">
            <a href="/articles" class="back-link">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                width="18"
                height="18"
              >
                <line x1="19" y1="12" x2="5" y2="12" />
                <polyline points="12 19 5 12 12 5" />
              </svg>
              Back to Articles
            </a>

            <div class="article-meta">
              <time datetime={article.data.date.toISOString()}>
                {formattedDate}
              </time>
              <span class="separator">·</span>
              <span>{readingTime} min read</span>
            </div>

            <h1>{article.data.title}</h1>

            {article.data.tags && article.data.tags.length > 0 && (
              <div class="article-tags">
                {article.data.tags.map((tag) => (
                  <a
                    href={`/articles?tag=${encodeURIComponent(tag)}`}
                    class="tag"
                  >
                    {tag}
                  </a>
                ))}
              </div>
            )}
          </header>
        )
      }

      <div class="prose">
        <Content />
      </div>
    </div>

    <!-- Lightbox Modal -->
    <div class="lightbox" id="lightbox" hidden>
      <button class="lightbox-close" aria-label="Close">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          width="32"
          height="32"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <button class="lightbox-nav lightbox-prev" aria-label="Previous">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          width="32"
          height="32"
        >
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      <button class="lightbox-nav lightbox-next" aria-label="Next">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          width="32"
          height="32"
        >
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
      <div class="lightbox-content">
        <img id="lightbox-img" src="" alt="" />
      </div>
      <div class="lightbox-counter" id="lightbox-counter"></div>
    </div>
  </article>
</Layout>

<script>
  function initLightbox() {
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightbox-img");
    const lightboxCounter = document.getElementById("lightbox-counter");
    const closeBtn = document.querySelector(".lightbox-close");
    const prevBtn = document.querySelector(".lightbox-prev");
    const nextBtn = document.querySelector(".lightbox-next");

    if (!lightbox) return;

    // Collect all prose images
    const proseImages = [];
    const proseImgElements = document.querySelectorAll(".prose img");

    proseImgElements.forEach((img) => {
      proseImages.push(img.src);
    });

    if (proseImages.length === 0) return;

    let currentIndex = 0;

    function showImage(index) {
      currentIndex = index;
      if (currentIndex < 0) currentIndex = proseImages.length - 1;
      if (currentIndex >= proseImages.length) currentIndex = 0;

      lightboxImg.src = proseImages[currentIndex];
      lightboxImg.alt = `Image ${currentIndex + 1}`;
      lightboxCounter.textContent = `${currentIndex + 1} / ${proseImages.length}`;
    }

    function openLightbox(index) {
      showImage(index);
      lightbox.hidden = false;
      document.body.style.overflow = "hidden";
    }

    function closeLightbox() {
      lightbox.hidden = true;
      document.body.style.overflow = "";
    }

    // Prose image triggers
    proseImgElements.forEach((img, idx) => {
      img.addEventListener("click", () => {
        openLightbox(idx);
      });
    });

    closeBtn?.addEventListener("click", closeLightbox);
    prevBtn?.addEventListener("click", () => showImage(currentIndex - 1));
    nextBtn?.addEventListener("click", () => showImage(currentIndex + 1));

    lightbox.addEventListener("click", (e) => {
      if (
        e.target === lightbox ||
        e.target.classList.contains("lightbox-content")
      ) {
        closeLightbox();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (lightbox.hidden) return;
      if (e.key === "Escape") closeLightbox();
      if (e.key === "ArrowLeft") showImage(currentIndex - 1);
      if (e.key === "ArrowRight") showImage(currentIndex + 1);
    });
  }

  initLightbox();
  document.addEventListener("astro:page-load", initLightbox);
</script>

<style>
  .article-detail {
    padding-bottom: var(--space-16);
  }

  /* Cover image styles */
  .article-cover {
    position: relative;
    min-height: 400px;
    display: flex;
    align-items: flex-end;
    margin-bottom: var(--space-10);
  }

  .cover-image {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .cover-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to top,
      rgba(0, 0, 0, 0.95) 0%,
      rgba(0, 0, 0, 0.7) 40%,
      rgba(0, 0, 0, 0.3) 70%,
      transparent 100%
    );
  }

  .article-cover.light .cover-overlay {
    background: linear-gradient(
      to top,
      rgba(255, 255, 255, 0.98) 0%,
      rgba(255, 255, 255, 0.85) 40%,
      rgba(255, 255, 255, 0.5) 70%,
      transparent 100%
    );
  }

  .cover-content {
    position: relative;
    z-index: 1;
    padding-top: calc(70px + var(--space-16));
    padding-bottom: var(--space-10);
    color: white;
  }

  .article-cover.light .cover-content {
    color: #18181b;
  }

  .article-cover .back-link {
    color: inherit;
    opacity: 0.75;
  }

  .article-cover .back-link:hover {
    opacity: 1;
  }

  .article-cover .article-meta {
    color: inherit;
    opacity: 0.75;
  }

  .article-cover h1 {
    color: inherit;
  }

  .article-cover .tag {
    background-color: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(4px);
    color: inherit;
    border: none;
  }

  .article-cover.light .tag {
    background-color: rgba(0, 0, 0, 0.08);
  }

  /* No cover styles */
  .article-header {
    padding-top: calc(70px + var(--space-16));
    margin-bottom: var(--space-10);
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    text-decoration: none;
    margin-bottom: var(--space-6);
    transition: color var(--transition-fast);
  }

  .back-link:hover {
    color: var(--color-text);
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  .separator {
    opacity: 0.5;
  }

  h1 {
    margin-bottom: var(--space-4);
  }

  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .article-tags .tag {
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .article-tags .tag:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
    background-color: var(--color-accent-subtle);
  }

  .prose {
    margin-top: var(--space-8);
  }

  /* Lightbox Modal */
  .lightbox {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: rgba(0, 0, 0, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox[hidden] {
    display: none;
  }

  .lightbox-content {
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox-content img {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    border-radius: var(--radius-md);
  }

  .lightbox-close {
    position: absolute;
    top: var(--space-4);
    right: var(--space-4);
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: var(--radius-full);
    padding: var(--space-2);
    cursor: pointer;
    color: white;
    transition: background var(--transition-fast);
  }

  .lightbox-close:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: var(--radius-full);
    padding: var(--space-3);
    cursor: pointer;
    color: white;
    transition: background var(--transition-fast);
  }

  .lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .lightbox-prev {
    left: var(--space-4);
  }

  .lightbox-next {
    right: var(--space-4);
  }

  .lightbox-counter {
    position: absolute;
    bottom: var(--space-4);
    left: 50%;
    transform: translateX(-50%);
    color: rgba(255, 255, 255, 0.7);
    font-size: var(--text-sm);
  }

  @media (max-width: 640px) {
    .lightbox-nav {
      padding: var(--space-2);
    }

    .lightbox-prev {
      left: var(--space-2);
    }

    .lightbox-next {
      right: var(--space-2);
    }
  }
</style>
