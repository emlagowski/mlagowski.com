---
import Layout from "../../components/Layout.astro";
import { getCollection, type CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const articles = await getCollection("articles");
  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

type Props = { article: CollectionEntry<"articles"> };
const { article } = Astro.props;
const { Content } = await article.render();

const formattedDate = article.data.date.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

// Calculate reading time (rough estimate: 200 words per minute)
const content = article.body || "";
const wordCount = content.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);

const hasCover = !!article.data.coverImage;
const coverTheme = article.data.coverTheme || "dark";
// Ensure cover image path starts with /
const coverImagePath = article.data.coverImage?.startsWith("/")
  ? article.data.coverImage
  : `/${article.data.coverImage}`;
---

<Layout title={article.data.title} description={article.data.description}>
  <article class="article-detail">
    {
      hasCover && (
        <div class={`article-cover ${coverTheme}`}>
          <img
            src={coverImagePath}
            alt={article.data.title}
            class="cover-image"
          />
          <div class="cover-overlay" />
          <div class="cover-content container container-narrow">
            <a href="/articles" class="back-link">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                width="18"
                height="18"
              >
                <line x1="19" y1="12" x2="5" y2="12" />
                <polyline points="12 19 5 12 12 5" />
              </svg>
              Back to Articles
            </a>

            <div class="article-meta">
              <time datetime={article.data.date.toISOString()}>
                {formattedDate}
              </time>
              <span class="separator">·</span>
              <span>{readingTime} min read</span>
            </div>

            <h1>{article.data.title}</h1>

            {article.data.tags && article.data.tags.length > 0 && (
              <div class="article-tags">
                {article.data.tags.map((tag) => (
                  <a
                    href={`/articles?tag=${encodeURIComponent(tag)}`}
                    class="tag"
                  >
                    {tag}
                  </a>
                ))}
              </div>
            )}
          </div>
        </div>
      )
    }

    <div class="container container-narrow">
      {
        !hasCover && (
          <header class="article-header">
            <a href="/articles" class="back-link">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                width="18"
                height="18"
              >
                <line x1="19" y1="12" x2="5" y2="12" />
                <polyline points="12 19 5 12 12 5" />
              </svg>
              Back to Articles
            </a>

            <div class="article-meta">
              <time datetime={article.data.date.toISOString()}>
                {formattedDate}
              </time>
              <span class="separator">·</span>
              <span>{readingTime} min read</span>
            </div>

            <h1>{article.data.title}</h1>

            {article.data.tags && article.data.tags.length > 0 && (
              <div class="article-tags">
                {article.data.tags.map((tag) => (
                  <a
                    href={`/articles?tag=${encodeURIComponent(tag)}`}
                    class="tag"
                  >
                    {tag}
                  </a>
                ))}
              </div>
            )}
          </header>
        )
      }

      <div class="prose">
        <Content />
      </div>
    </div>
  </article>
</Layout>

<style>
  .article-detail {
    padding-bottom: var(--space-16);
  }

  /* Cover image styles */
  .article-cover {
    position: relative;
    min-height: 400px;
    display: flex;
    align-items: flex-end;
    margin-bottom: var(--space-10);
  }

  .cover-image {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .cover-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to top,
      rgba(0, 0, 0, 0.95) 0%,
      rgba(0, 0, 0, 0.7) 40%,
      rgba(0, 0, 0, 0.3) 70%,
      transparent 100%
    );
  }

  .article-cover.light .cover-overlay {
    background: linear-gradient(
      to top,
      rgba(255, 255, 255, 0.98) 0%,
      rgba(255, 255, 255, 0.85) 40%,
      rgba(255, 255, 255, 0.5) 70%,
      transparent 100%
    );
  }

  .cover-content {
    position: relative;
    z-index: 1;
    padding-top: calc(70px + var(--space-16));
    padding-bottom: var(--space-10);
    color: white;
  }

  .article-cover.light .cover-content {
    color: #18181b;
  }

  .article-cover .back-link {
    color: inherit;
    opacity: 0.75;
  }

  .article-cover .back-link:hover {
    opacity: 1;
  }

  .article-cover .article-meta {
    color: inherit;
    opacity: 0.75;
  }

  .article-cover h1 {
    color: inherit;
  }

  .article-cover .tag {
    background-color: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(4px);
    color: inherit;
    border: none;
  }

  .article-cover.light .tag {
    background-color: rgba(0, 0, 0, 0.08);
  }

  /* No cover styles */
  .article-header {
    padding-top: calc(70px + var(--space-16));
    margin-bottom: var(--space-10);
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    text-decoration: none;
    margin-bottom: var(--space-6);
    transition: color var(--transition-fast);
  }

  .back-link:hover {
    color: var(--color-text);
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  .separator {
    opacity: 0.5;
  }

  h1 {
    margin-bottom: var(--space-4);
  }

  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .article-tags .tag {
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .article-tags .tag:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
    background-color: var(--color-accent-subtle);
  }

  .prose {
    margin-top: var(--space-8);
  }
</style>
